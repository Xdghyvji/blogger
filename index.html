<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Blog Agent Pro</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>
<body class="bg-slate-50 text-slate-900 min-h-screen font-sans">

    <!-- Header -->
    <nav class="bg-white border-b border-slate-200 sticky top-0 z-50">
        <div class="max-w-7xl mx-auto px-4 h-16 flex items-center justify-between">
            <div class="flex items-center gap-2">
                <div class="bg-blue-600 p-2 rounded-lg">
                    <i class="fas fa-robot text-white text-xl"></i>
                </div>
                <span class="font-bold text-xl tracking-tight">BlogAgent<span class="text-blue-600">AI</span></span>
            </div>
            <div id="authStatus" class="text-sm font-medium text-slate-500">
                Initializing Database...
            </div>
        </div>
    </nav>

    <main class="max-w-6xl mx-auto p-4 md:p-8 grid grid-cols-1 lg:grid-cols-12 gap-8">
        
        <!-- Sidebar: Configuration -->
        <div class="lg:col-span-4 space-y-6">
            <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-200">
                <h2 class="font-bold text-lg mb-4 flex items-center gap-2">
                    <i class="fas fa-magic text-blue-500"></i> Write New Post
                </h2>
                
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-semibold text-slate-700 mb-1">Target Keyword / Topic</label>
                        <input type="text" id="topicInput" placeholder="e.g. Benefits of Mediterranean Diet" 
                               class="w-full px-4 py-2 rounded-xl border border-slate-200 focus:ring-2 focus:ring-blue-500 focus:border-transparent outline-none transition-all">
                    </div>

                    <div>
                        <label class="block text-sm font-semibold text-slate-700 mb-1">Tone of Voice</label>
                        <select id="toneSelect" class="w-full px-4 py-2 rounded-xl border border-slate-200 outline-none">
                            <option value="Professional">Professional</option>
                            <option value="Conversational">Conversational</option>
                            <option value="Technical">Technical</option>
                        </select>
                    </div>

                    <button id="generateBtn" onclick="processBlog()"
                            class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 rounded-xl transition-all shadow-lg shadow-blue-200 flex items-center justify-center gap-2">
                        <span>Generate Blog</span>
                        <i class="fas fa-paper-plane"></i>
                    </button>
                </div>
            </div>

            <!-- API Key Warning/Setup -->
            <div id="apiKeySection" class="bg-amber-50 p-6 rounded-2xl border border-amber-200 hidden">
                <h3 class="font-bold text-amber-800 text-sm mb-2 flex items-center gap-2">
                    <i class="fas fa-key"></i> Missing Gemini API Key
                </h3>
                <p class="text-xs text-amber-700 mb-3">Your API key is not found in Firestore (settings/gemini). Please add it below to save it securely.</p>
                <div class="flex gap-2">
                    <input type="password" id="manualApiKey" placeholder="AIza..." class="flex-1 text-xs p-2 rounded border border-amber-300">
                    <button onclick="saveApiKey()" class="bg-amber-600 text-white px-3 py-1 rounded text-xs">Save</button>
                </div>
            </div>

            <div class="bg-slate-900 text-white p-6 rounded-2xl shadow-xl">
                <h3 class="font-bold mb-2">Automated Tasks:</h3>
                <ul class="text-sm space-y-2 text-slate-400">
                    <li class="flex items-center gap-2"><i class="fas fa-check text-green-400"></i> SEO Metadata</li>
                    <li class="flex items-center gap-2"><i class="fas fa-check text-green-400"></i> Plagiarism Check</li>
                    <li class="flex items-center gap-2"><i class="fas fa-check text-green-400"></i> Authority Links</li>
                    <li class="flex items-center gap-2"><i class="fas fa-check text-green-400"></i> Unsplash Thumbnail</li>
                </ul>
            </div>
        </div>

        <!-- Main Content Area: Editor/Preview -->
        <div class="lg:col-span-8 space-y-6">
            
            <!-- Loading State -->
            <div id="loadingState" class="hidden animate-pulse space-y-4">
                <div class="h-64 bg-slate-200 rounded-2xl"></div>
                <div class="h-8 bg-slate-200 w-3/4 rounded"></div>
                <div class="h-4 bg-slate-200 w-full rounded"></div>
                <div class="h-4 bg-slate-200 w-5/6 rounded"></div>
            </div>

            <!-- Output Display -->
            <div id="outputDisplay" class="hidden space-y-6">
                
                <!-- SEO & Meta Card -->
                <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-200 overflow-x-auto">
                    <h3 class="font-bold text-slate-800 mb-4 flex items-center gap-2">
                        <i class="fas fa-search text-blue-500"></i> SEO & Meta Data
                    </h3>
                    <div id="metaGrid" class="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm">
                        <!-- Filled by JS -->
                    </div>
                </div>

                <!-- Blog Post Area -->
                <article class="bg-white p-8 md:p-12 rounded-2xl shadow-sm border border-slate-200">
                    <div id="thumbnailContainer" class="mb-8 rounded-xl overflow-hidden shadow-lg h-80 bg-slate-100 hidden">
                        <img id="postThumbnail" src="" alt="Post Thumbnail" class="w-full h-full object-cover">
                    </div>
                    
                    <div id="blogBody" class="prose prose-slate max-w-none">
                        <!-- AI Content injected here -->
                    </div>
                </article>

                <div class="flex justify-end gap-3 pb-8">
                    <button onclick="window.print()" class="px-6 py-2 rounded-xl border border-slate-200 bg-white font-medium hover:bg-slate-50 transition-all">
                        Print / PDF
                    </button>
                    <button onclick="saveToFirestore()" class="px-6 py-2 rounded-xl bg-green-600 text-white font-medium hover:bg-green-700 transition-all">
                        Save to Firebase
                    </button>
                </div>
            </div>

            <!-- Empty State -->
            <div id="emptyState" class="bg-white border-2 border-dashed border-slate-200 rounded-3xl p-12 text-center">
                <div class="bg-slate-50 w-20 h-20 rounded-full flex items-center justify-center mx-auto mb-4">
                    <i class="fas fa-feather-pointed text-slate-300 text-3xl"></i>
                </div>
                <h3 class="text-slate-500 font-medium text-lg">Your masterpiece starts here.</h3>
                <p class="text-slate-400 text-sm mt-1">Enter a topic on the left to begin generation.</p>
            </div>

        </div>
    </main>

    <!-- Firebase Scripts -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-app.js";
        import { getFirestore, doc, getDoc, setDoc, collection, addDoc } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-firestore.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-auth.js";

        // Your Firebase Config
        const firebaseConfig = {
            apiKey: "AIzaSyBPyGJ_qX58Ye3Z8BTiKnYGNMYROnyHlGA",
            authDomain: "mubashir-2b7cc.firebaseapp.com",
            projectId: "mubashir-2b7cc",
            storageBucket: "mubashir-2b7cc.firebasestorage.app",
            messagingSenderId: "107494735119",
            appId: "1:107494735119:web:43e3c6dff8a0e67b9e527a",
            measurementId: "G-2JY12046QH"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);

        let GEMINI_API_KEY = "";
        let currentGeneratedContent = null;

        // Auth Logic
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                document.getElementById('authStatus').innerHTML = `<span class="flex items-center gap-1"><span class="w-2 h-2 bg-green-500 rounded-full"></span> Database Online</span>`;
                fetchApiKey();
            } else {
                signInAnonymously(auth);
            }
        });

        // 1. Fetch API Key from Firestore
        async function fetchApiKey() {
            try {
                const docRef = doc(db, "settings", "gemini");
                const docSnap = await getDoc(docRef);
                if (docSnap.exists()) {
                    GEMINI_API_KEY = docSnap.data().key;
                    document.getElementById('apiKeySection').classList.add('hidden');
                } else {
                    document.getElementById('apiKeySection').classList.remove('hidden');
                }
            } catch (e) {
                console.error("Error fetching API Key", e);
            }
        }

        // Save API Key to Firestore
        window.saveApiKey = async () => {
            const key = document.getElementById('manualApiKey').value;
            if(!key) return alert("Enter a key");
            try {
                await setDoc(doc(db, "settings", "gemini"), { key: key });
                GEMINI_API_KEY = key;
                document.getElementById('apiKeySection').classList.add('hidden');
                alert("API Key saved to Firestore!");
            } catch (e) {
                alert("Error saving key: " + e.message);
            }
        };

        // 2. The Agent Logic
        window.processBlog = async () => {
            const topic = document.getElementById('topicInput').value;
            if(!topic) return alert("Please enter a topic");
            if(!GEMINI_API_KEY) return alert("No API Key found. Add it in the yellow box.");

            // UI State
            document.getElementById('emptyState').classList.add('hidden');
            document.getElementById('outputDisplay').classList.add('hidden');
            document.getElementById('loadingState').classList.remove('hidden');

            try {
                // Task 1: Generate Content with Gemini
                const aiResponse = await callGemini(topic);
                const blogData = JSON.parse(aiResponse);
                currentGeneratedContent = blogData;

                // Task 2: Fetch Image from Unsplash (Free Search API)
                const imageUrl = await fetchUnsplashImage(topic);

                // Task 3: Render
                renderBlog(blogData, imageUrl);

            } catch (e) {
                console.error(e);
                alert("Generation failed. Check console or API key.");
            } finally {
                document.getElementById('loadingState').classList.add('hidden');
                document.getElementById('outputDisplay').classList.remove('hidden');
            }
        };

        async function callGemini(topic) {
            const tone = document.getElementById('toneSelect').value;
            const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${GEMINI_API_KEY}`;
            
            const prompt = `You are a professional SEO blog writer. Write a comprehensive blog post about "${topic}" in a ${tone} tone. 
            Format the response as a valid JSON object ONLY, with these keys: 
            "title" (H1), 
            "content" (HTML string with H2, H3, lists, and bold text), 
            "meta_title", 
            "meta_description", 
            "tags" (comma separated), 
            "canonical_url" (placeholder),
            "external_links" (Array of 2 real authority site URLs like Wikipedia or News related to topic).
            Ensure the content is high-quality, plagiarism-free, and informative.`;

            const response = await fetch(url, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
            });
            const data = await response.json();
            
            // Clean JSON string if AI adds markdown backticks
            let text = data.candidates[0].content.parts[0].text;
            return text.replace(/```json|```/gi, "").trim();
        }

        async function fetchUnsplashImage(query) {
            try {
                const response = await fetch(`https://source.unsplash.com/featured/1200x800?${encodeURIComponent(query)}`);
                if (response.url) return response.url;
            } catch (e) { return null; }
        }

        function renderBlog(data, imageUrl) {
            // Render Meta
            const metaGrid = document.getElementById('metaGrid');
            metaGrid.innerHTML = `
                <div class="p-3 bg-slate-50 rounded-lg"><strong>Meta Title:</strong><br>${data.meta_title}</div>
                <div class="p-3 bg-slate-50 rounded-lg"><strong>Meta Desc:</strong><br>${data.meta_description}</div>
                <div class="p-3 bg-slate-50 rounded-lg"><strong>Tags:</strong><br>${data.tags}</div>
                <div class="p-3 bg-slate-50 rounded-lg"><strong>Canonical:</strong><br>${data.canonical_url}</div>
            `;

            // Render Image
            const thumbCont = document.getElementById('thumbnailContainer');
            if(imageUrl) {
                document.getElementById('postThumbnail').src = imageUrl;
                thumbCont.classList.remove('hidden');
            }

            // Render Body
            const blogBody = document.getElementById('blogBody');
            blogBody.innerHTML = `
                <h1 class="text-4xl font-extrabold mb-6">${data.title}</h1>
                ${data.content}
                <div class="mt-8 pt-6 border-t border-slate-100">
                    <h4 class="font-bold text-slate-700 mb-2 underline underline-offset-4 decoration-blue-500">Authority References:</h4>
                    <ul class="text-blue-600">
                        ${data.external_links.map(link => `<li><a href="${link}" target="_blank" class="hover:underline">${link}</a></li>`).join('')}
                    </ul>
                </div>
            `;
        }

        window.saveToFirestore = async () => {
            if(!currentGeneratedContent) return;
            try {
                const docRef = await addDoc(collection(db, "generated_posts"), {
                    ...currentGeneratedContent,
                    createdAt: new Date(),
                    thumbnail: document.getElementById('postThumbnail').src
                });
                alert("Successfully saved to Firestore collection 'generated_posts'!");
            } catch (e) {
                alert("Save failed: " + e.message);
            }
        };

    </script>

</body>
</html>
